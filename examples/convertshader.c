#include <SDL3_shader/SDL_shader.h>

const char* GLSL_CODE =
    "#version 450\n"
    "layout(location = 0) in vec4 Color;\n"
    "layout(location = 0) out vec4 FragColor;\n"
    "void main() { FragColor = Color; }";

const char SPIRV_CODE[] = {
    0x3,  0x2,  0x23, 0x7,  0x0,  0x0,  0x1,  0x0,  0xb,  0x0,  0x8,  0x0,  0xd,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x11, 0x0,  0x2,  0x0,  0x1,  0x0,  0x0,  0x0,  0xb,  0x0,  0x6,  0x0,  0x1,  0x0,  0x0,  0x0,  0x47, 0x4c, 0x53, 0x4c,
    0x2e, 0x73, 0x74, 0x64, 0x2e, 0x34, 0x35, 0x30, 0x0,  0x0,  0x0,  0x0,  0xe,  0x0,  0x3,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x1,  0x0,  0x0,  0x0,  0xf,  0x0,  0x7,  0x0,  0x4,  0x0,  0x0,  0x0,  0x4,  0x0,  0x0,  0x0,  0x6d, 0x61, 0x69, 0x6e,
    0x0,  0x0,  0x0,  0x0,  0x9,  0x0,  0x0,  0x0,  0xb,  0x0,  0x0,  0x0,  0x10, 0x0,  0x3,  0x0,  0x4,  0x0,  0x0,  0x0,
    0x7,  0x0,  0x0,  0x0,  0x3,  0x0,  0x3,  0x0,  0x2,  0x0,  0x0,  0x0,  0xc2, 0x1,  0x0,  0x0,  0x5,  0x0,  0x4,  0x0,
    0x4,  0x0,  0x0,  0x0,  0x6d, 0x61, 0x69, 0x6e, 0x0,  0x0,  0x0,  0x0,  0x5,  0x0,  0x5,  0x0,  0x9,  0x0,  0x0,  0x0,
    0x46, 0x72, 0x61, 0x67, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x0,  0x0,  0x0,  0x5,  0x0,  0x4,  0x0,  0xb,  0x0,  0x0,  0x0,
    0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x0,  0x0,  0x0,  0x47, 0x0,  0x4,  0x0,  0x9,  0x0,  0x0,  0x0,  0x1e, 0x0,  0x0,  0x0,
    0x0,  0x0,  0x0,  0x0, 0x47,  0x0,  0x4,  0x0,  0xb,  0x0,  0x0,  0x0,  0x1e, 0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
    0x13, 0x0,  0x2,  0x0,  0x2,  0x0,  0x0,  0x0,  0x21, 0x0,  0x3,  0x0,  0x3,  0x0,  0x0,  0x0,  0x2,  0x0,  0x0,  0x0,
    0x16, 0x0,  0x3,  0x0,  0x6,  0x0,  0x0,  0x0,  0x20, 0x0,  0x0,  0x0,  0x17, 0x0,  0x4,  0x0,  0x7,  0x0,  0x0,  0x0,
    0x6,  0x0,  0x0,  0x0,  0x4,  0x0,  0x0,  0x0,  0x20, 0x0,  0x4,  0x0,  0x8,  0x0,  0x0,  0x0,  0x3,  0x0,  0x0,  0x0,
    0x7,  0x0,  0x0,  0x0,  0x3b, 0x0,  0x4,  0x0,  0x8,  0x0,  0x0,  0x0,  0x9,  0x0,  0x0,  0x0,  0x3,  0x0,  0x0,  0x0,
    0x20, 0x0,  0x4,  0x0,  0xa,  0x0,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x7,  0x0,  0x0,  0x0,  0x3b, 0x0,  0x4,  0x0,
    0xa,  0x0,  0x0,  0x0,  0xb,  0x0,  0x0,  0x0,  0x1,  0x0,  0x0,  0x0,  0x36, 0x0,  0x5,  0x0,  0x2,  0x0,  0x0,  0x0,
    0x4,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x3,  0x0,  0x0,  0x0,  0xf8, 0x0,  0x2,  0x0,  0x5,  0x0,  0x0,  0x0,
    0x3d, 0x0,  0x4,  0x0,  0x7,  0x0,  0x0,  0x0,  0xc,  0x0,  0x0,  0x0,  0xb,  0x0,  0x0,  0x0,  0x3e, 0x0,  0x3,  0x0,
    0x9,  0x0,  0x0,  0x0,  0xc,  0x0,  0x0,  0x0,  0xfd, 0x0,  0x1,  0x0,  0x38, 0x0,  0x1,  0x0
};

int main(int argc, char** argv)
{
    size_t hlslLength;
    const char *hlslText = NULL;
    Uint64 then, now;

    const SDL_Version *sdlShaderVersion = SHD_Linked_Version();
    SDL_Log("Linked with SDL_shader v%d.%d.%d", sdlShaderVersion->major, sdlShaderVersion->minor, sdlShaderVersion->patch);

    /* Initialize the library */
    if (SHD_Init() != 0) {
        SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "%s\n", SDL_GetError());
        return 1;
    }

    /* Direct SPIR-V conversion */
    then = SDL_GetTicks();
    hlslText = SHD_TranslateFromSPIRV(SDL_GPU_BACKEND_D3D11, (void*) SPIRV_CODE, SDL_arraysize(SPIRV_CODE), &hlslLength);
    if (!hlslText)
    {
        SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "%s\n", SHD_GetError());
        return 1;
    }

    now = SDL_GetTicks();

    SDL_Log("Translated SPIRV shader to HLSL in %llu milliseconds | HLSL size: %llu:\n%s\n\n", (now - then), hlslLength, hlslText);
    SDL_free((void*) hlslText);

    /* GLSL -> SPIR-V -> HLSL conversion */
    then = SDL_GetTicks();
    hlslText = SHD_TranslateFromGLSL(SDL_GPU_BACKEND_D3D11, SDL_GPU_SHADERTYPE_FRAGMENT, (void*) GLSL_CODE, SDL_strlen(GLSL_CODE), &hlslLength);
    if (!hlslText)
    {
        /* This isn't fatal, the library may have not been compiled with GLSL support */
        SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "%s\n", SHD_GetError());
    }
    else
    {
        now = SDL_GetTicks();

        SDL_Log("Translated GLSL shader to HLSL in %llu milliseconds | HLSL size %llu:\n%s\n\n", (now - then), hlslLength, hlslText);
        SDL_free((void*)hlslText);
    }

    SHD_Quit();

    return 0;
}